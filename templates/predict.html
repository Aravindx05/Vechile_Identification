{% extends "base.html" %}

{% block title %}Prediction - VANET Routing Analysis{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="fas fa-magic text-info me-2"></i>Prediction Tool
                    </h1>
                    <p class="text-muted">Enter vehicle and network parameters to predict optimal route and vehicle spacing</p>
                </div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
                        <li class="breadcrumb-item active">Prediction</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-keyboard me-2"></i>Input Parameters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('predict') }}">
                        <div class="row">
                            <!-- Vehicle Parameters -->
                            <div class="col-md-6 mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-car me-2"></i>Vehicle Parameters
                                </h6>
                                
                                <div class="mb-3">
                                    <label for="vehicle_speed" class="form-label">
                                        Vehicle Speed (km/h)
                                        <small class="text-muted">- Current speed of the vehicle</small>
                                    </label>
                                    <input type="number" step="0.01" class="form-control" id="vehicle_speed" 
                                           name="vehicle_speed" placeholder="e.g., 65.5" 
                                           value="{{ results.input_data.vehicle_speed if results and results.input_data else '' }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="signal_strength" class="form-label">
                                        Signal Strength (dBm)
                                        <small class="text-muted">- Communication signal strength</small>
                                    </label>
                                    <input type="number" step="0.01" class="form-control" id="signal_strength" 
                                           name="signal_strength" placeholder="e.g., -65.5" 
                                           value="{{ results.input_data.signal_strength if results and results.input_data else '' }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="distance_to_destination" class="form-label">
                                        Distance to Destination (km)
                                        <small class="text-muted">- Remaining distance to target</small>
                                    </label>
                                    <input type="number" step="0.01" class="form-control" id="distance_to_destination" 
                                           name="distance_to_destination" placeholder="e.g., 15.5" 
                                           value="{{ results.input_data.distance_to_destination if results and results.input_data else '' }}" required>
                                </div>
                            </div>
                            
                            <!-- Network Parameters -->
                            <div class="col-md-6 mb-4">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-network-wired me-2"></i>Network Parameters
                                </h6>
                                
                                <div class="mb-3">
                                    <label for="traffic_density" class="form-label">
                                        Traffic Density (vehicles/km)
                                        <small class="text-muted">- Number of vehicles per kilometer</small>
                                    </label>
                                    <input type="number" step="0.01" class="form-control" id="traffic_density" 
                                           name="traffic_density" placeholder="e.g., 25.3" 
                                           value="{{ results.input_data.traffic_density if results and results.input_data else '' }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="route_stability_score" class="form-label">
                                        Route Stability Score (0-1)
                                        <small class="text-muted">- Route stability measurement</small>
                                    </label>
                                    <input type="number" step="0.001" min="0" max="1" class="form-control" id="route_stability_score" 
                                           name="route_stability_score" placeholder="e.g., 0.75" 
                                           value="{{ results.input_data.route_stability_score if results and results.input_data else '' }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="packet_loss_rate" class="form-label">
                                        Packet Loss Rate (%)
                                        <small class="text-muted">- Network packet loss percentage</small>
                                    </label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="packet_loss_rate" 
                                           name="packet_loss_rate" placeholder="e.g., 2.5" 
                                           value="{{ results.input_data.packet_loss_rate if results and results.input_data else '' }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="rsu_coverage_score" class="form-label">
                                        RSU Coverage Score (0-1)
                                        <small class="text-muted">- Road Side Unit coverage quality</small>
                                    </label>
                                    <input type="number" step="0.001" min="0" max="1" class="form-control" id="rsu_coverage_score" 
                                           name="rsu_coverage_score" placeholder="e.g., 0.85" 
                                           value="{{ results.input_data.rsu_coverage_score if results and results.input_data else '' }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Road Parameters -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-road me-2"></i>Road Parameters
                                </h6>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="lane_count" class="form-label">
                                            Lane Count
                                            <small class="text-muted">- Number of road lanes</small>
                                        </label>
                                        <select class="form-select" id="lane_count" name="lane_count" required>
                                            <option value="">Select number of lanes</option>
                                            {% for i in range(1, 6) %}
                                            <option value="{{ i }}" 
                                                {% if results and results.input_data and results.input_data.lane_count == i %}selected{% endif %}>
                                                {{ i }} lane{{ 's' if i > 1 else '' }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="road_priority" class="form-label">
                                            Road Priority Level
                                            <small class="text-muted">- Priority level of the road</small>
                                        </label>
                                        <select class="form-select" id="road_priority" name="road_priority" required>
                                            <option value="">Select priority level</option>
                                            {% for i in range(1, 6) %}
                                            <option value="{{ i }}" 
                                                {% if results and results.input_data and results.input_data.road_priority == i %}selected{% endif %}>
                                                Priority {{ i }} {% if i == 1 %}(Lowest){% elif i == 5 %}(Highest){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-info btn-lg">
                                    <i class="fas fa-brain me-2"></i>Generate Predictions
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-lg ms-2">
                                    <i class="fas fa-undo me-2"></i>Reset Form
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Prediction Results -->
    {% if results %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Prediction Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Classification Results -->
                        {% if results.classification %}
                        <div class="col-md-6 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-route me-2"></i>Route Optimization (Classification)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for model_name, prediction in results.classification.items() %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">{{ model_name }}:</span>
                                        <span class="badge {% if prediction[0] == 'Optimal' %}bg-success{% else %}bg-warning text-dark{% endif %} fs-6">
                                            {{ prediction[0] }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                    
                                    <!-- Summary -->
                                    {% set optimal_count = results.classification.values() | selectattr('0', 'equalto', 'Optimal') | list | length %}
                                    {% set total_models = results.classification | length %}
                                    <hr>
                                    <div class="text-center">
                                        <h6 class="text-muted">Recommendation Summary</h6>
                                        {% if optimal_count > total_models / 2 %}
                                        <div class="alert alert-success mb-0" role="alert">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>Optimal Route Recommended</strong><br>
                                            {{ optimal_count }}/{{ total_models }} models suggest taking this route
                                        </div>
                                        {% else %}
                                        <div class="alert alert-warning mb-0" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Alternative Route Suggested</strong><br>
                                            {{ total_models - optimal_count }}/{{ total_models }} models suggest finding an alternative
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Regression Results -->
                        {% if results.regression %}
                        <div class="col-md-6 mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-arrows-alt-h me-2"></i>Vehicle Spacing Prediction (Regression)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for model_name, prediction in results.regression.items() %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-bold">{{ model_name }}:</span>
                                        <span class="badge bg-info fs-6">
                                            {{ "%.2f"|format(prediction[0]) }} meters
                                        </span>
                                    </div>
                                    {% endfor %}
                                    
                                    <!-- Average -->
                                    {% set spacing_values = results.regression.values() | map('first') | list %}
                                    {% set avg_spacing = (spacing_values | sum) / (spacing_values | length) %}
                                    <hr>
                                    <div class="text-center">
                                        <h6 class="text-muted">Average Prediction</h6>
                                        <div class="alert alert-info mb-0" role="alert">
                                            <i class="fas fa-calculator me-2"></i>
                                            <strong>Expected Vehicle Spacing:</strong><br>
                                            {{ "%.2f"|format(avg_spacing) }} meters
                                            {% if avg_spacing < 20 %}
                                            <br><small class="text-muted">(High density traffic)</small>
                                            {% elif avg_spacing > 50 %}
                                            <br><small class="text-muted">(Low density traffic)</small>
                                            {% else %}
                                            <br><small class="text-muted">(Moderate density traffic)</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form validation
    const form = document.querySelector('form');
    const submitBtn = document.querySelector('button[type="submit"]');
    
    // Real-time validation
    const inputs = document.querySelectorAll('input[type="number"], select');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            validateInput(this);
        });
    });
    
    function validateInput(input) {
        input.classList.remove('is-invalid', 'is-valid');
        
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (isNaN(value)) {
                input.classList.add('is-invalid');
                return false;
            }
            
            if (min !== undefined && value < min) {
                input.classList.add('is-invalid');
                return false;
            }
            
            if (max !== undefined && value > max) {
                input.classList.add('is-invalid');
                return false;
            }
        }
        
        if (input.value.trim() === '') {
            input.classList.add('is-invalid');
            return false;
        }
        
        input.classList.add('is-valid');
        return true;
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        let isValid = true;
        inputs.forEach(input => {
            if (!validateInput(input)) {
                isValid = false;
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please correct the highlighted fields before submitting.');
        }
    });
    
    // Auto-fill with sample data
    const sampleBtn = document.createElement('button');
    sampleBtn.type = 'button';
    sampleBtn.className = 'btn btn-outline-info ms-2';
    sampleBtn.innerHTML = '<i class="fas fa-flask me-1"></i>Fill Sample Data';
    sampleBtn.addEventListener('click', fillSampleData);
    
    const resetBtn = document.querySelector('button[type="reset"]');
    resetBtn.parentNode.insertBefore(sampleBtn, resetBtn.nextSibling);
    
    function fillSampleData() {
        document.getElementById('vehicle_speed').value = '65.5';
        document.getElementById('traffic_density').value = '25.3';
        document.getElementById('route_stability_score').value = '0.75';
        document.getElementById('packet_loss_rate').value = '2.5';
        document.getElementById('signal_strength').value = '-65.5';
        document.getElementById('distance_to_destination').value = '15.8';
        document.getElementById('rsu_coverage_score').value = '0.85';
        document.getElementById('lane_count').value = '4';
        document.getElementById('road_priority').value = '3';
        
        // Trigger validation for all inputs
        inputs.forEach(input => {
            validateInput(input);
        });
    }
});
</script>
{% endblock %}